name: Deploy Docsify Site

on:
  push:
    branches:
      - master  # ä¿®æ­£åˆ†æ”¯åç§°
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1ï¸âƒ£ Checkout ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ é…ç½® Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # 3ï¸âƒ£ æ„å»º Docsify ç½‘ç«™
      - name: Build Docsify site
        run: |
          mkdir -p _site
          
          # è¿ç§»æ—§ç›®å½•åˆ° archive æŒ‰æœˆå½’æ¡£
          if [ -f "scripts/organize_reports.py" ]; then
            echo "ğŸ”„ è¿ç§»æ—§ç›®å½•åˆ° archive..."
            python3 scripts/organize_reports.py
          fi
          
          # è‡ªåŠ¨ç”Ÿæˆä¾§è¾¹æ ç›®å½•
          echo "ğŸ”„ ç”Ÿæˆä¾§è¾¹æ ç›®å½•..."
          python3 scripts/generate_sidebar.py
          
          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          echo "ğŸ“ å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶..."
          cp index.html README.md _site/
          
          # å¤åˆ¶ä¾§è¾¹æ å’Œå°é¢
          if [ -f "web/_sidebar.md" ]; then 
            cp web/_sidebar.md _site/
            echo "âœ… å¤åˆ¶ä¾§è¾¹æ "
          fi
          if [ -f "web/_coverpage.md" ]; then 
            cp web/_coverpage.md _site/
            echo "âœ… å¤åˆ¶å°é¢é¡µ"
          fi
          if [ -f "web/_404.md" ]; then 
            cp web/_404.md _site/
            echo "âœ… å¤åˆ¶404é¡µé¢"
          fi

          # å¤åˆ¶å½’æ¡£ç›®å½•ï¼ˆæ–°ç»“æ„ï¼‰
          if [ -d "archive" ]; then 
            cp -r archive _site/
            echo "âœ… å¤åˆ¶å½’æ¡£ç›®å½•"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° archive ç›®å½•"
          fi
          
          # æ˜¾ç¤ºæ„å»ºç»“æœ
          echo "ğŸ“Š æ„å»ºå®Œæˆï¼Œæ–‡ä»¶ç»Ÿè®¡ï¼š"
          find _site -type f | wc -l | xargs echo "æ€»æ–‡ä»¶æ•°ï¼š"
          echo "ğŸ“ ç›®å½•ç»“æ„ï¼š"
          find _site -type d | head -10

      # 4ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      # 5ï¸âƒ£ éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
