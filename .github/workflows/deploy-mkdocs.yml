# GitHub Actions å·¥ä½œæµï¼šè‡ªåŠ¨éƒ¨ç½² MkDocs æ–‡æ¡£ç½‘ç«™
# å½“ä»£ç æ¨é€åˆ° main/master åˆ†æ”¯æ—¶ï¼Œè‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åˆ° GitHub Pages

name: Deploy MkDocs Site

# è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€å’Œæ‹‰å–è¯·æ±‚
on:
  push:
    branches:
      - main      # ä¸»åˆ†æ”¯æ¨é€æ—¶è§¦å‘
      - master    # å…¼å®¹æ—§çš„ä¸»åˆ†æ”¯åç§°
  pull_request:
    branches:
      - main      # å‘ä¸»åˆ†æ”¯æäº¤ PR æ—¶è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
      - master

# æƒé™è®¾ç½®ï¼šå…è®¸è¯»å–ä»£ç ã€å†™å…¥ Pagesã€ä½¿ç”¨ ID Token
permissions:
  contents: read    # è¯»å–ä»“åº“å†…å®¹
  pages: write      # å†™å…¥ GitHub Pages
  id-token: write   # ä½¿ç”¨ OIDC è¿›è¡Œèº«ä»½éªŒè¯

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª Pages éƒ¨ç½²ä»»åŠ¡è¿è¡Œ
concurrency:
  group: "pages"           # åŒä¸€ç»„å†…çš„ä»»åŠ¡äº’æ–¥
  cancel-in-progress: false # ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡

jobs:
  # æ„å»ºä»»åŠ¡ï¼šç”Ÿæˆé™æ€ç½‘ç«™æ–‡ä»¶
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # æ­¥éª¤ 2ï¼šè®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11  # ä½¿ç”¨ Python 3.11

      # æ­¥éª¤ 3ï¼šç¼“å­˜ä¾èµ–åŒ…ï¼ˆåŠ é€Ÿåç»­æ„å»ºï¼‰
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}  # åŸºäºä¾èµ–æ–‡ä»¶çš„ç¼“å­˜é”®
          path: ~/.cache/pip  # pip ç¼“å­˜è·¯å¾„

      # æ­¥éª¤ 4ï¼šå®‰è£… Python ä¾èµ–åŒ…
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip  # å‡çº§ pip
          pip install -r requirements.txt     # å®‰è£…é¡¹ç›®ä¾èµ–

      # æ­¥éª¤ 5ï¼šé…ç½® GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v3

      # æ­¥éª¤ 6ï¼šç”ŸæˆåŠ¨æ€å¯¼èˆªèœå•
      # æ‰«æ archive ç›®å½•ï¼Œè‡ªåŠ¨ç”Ÿæˆ mkdocs.yml ä¸­çš„ nav é…ç½®
      - name: Generate navigation
        run: python3 scripts/generate_mkdocs_nav.py

      # æ­¥éª¤ 7ï¼šä½¿ç”¨ MkDocs æ„å»ºé™æ€ç½‘ç«™
      - name: Build with MkDocs
        run: mkdocs build  # ç”Ÿæˆé™æ€æ–‡ä»¶åˆ° site/ ç›®å½•

      # æ­¥éª¤ 7.5ï¼šéªŒè¯æ„å»ºç»“æœ
      - name: Verify build output
        run: |
          echo "ğŸ“ æ£€æŸ¥æ„å»ºè¾“å‡º..."
          ls -la site/
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡ï¼š"
          find site/ -name "*.html" | wc -l
          echo "âœ… æ„å»ºéªŒè¯å®Œæˆ"

      # æ­¥éª¤ 8ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site  # ä¸Šä¼  site/ ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶

  # éƒ¨ç½²ä»»åŠ¡ï¼šå°†æ„å»ºäº§ç‰©éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    environment:
      name: github-pages                    # GitHub Pages ç¯å¢ƒåç§°
      url: ${{ steps.deployment.outputs.page_url }}  # éƒ¨ç½²åçš„ç½‘ç«™ URL
    runs-on: ubuntu-latest
    needs: build                           # ä¾èµ– build ä»»åŠ¡å®Œæˆ
    # åªåœ¨ä¸»åˆ†æ”¯ä¸Šéƒ¨ç½²ï¼ŒPR ä¸éƒ¨ç½²
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      # æ­¥éª¤ 1ï¼šéƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # æ­¥éª¤ 2ï¼šéªŒè¯éƒ¨ç½²ç»“æœ
      - name: Verify deployment
        run: |
          echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“Š ç½‘ç«™åœ°å€ï¼šhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ”— éƒ¨ç½² URLï¼š${{ steps.deployment.outputs.page_url }}"
          echo "â° éƒ¨ç½²æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŒ¿ åˆ†æ”¯ï¼š${{ github.ref_name }}"
