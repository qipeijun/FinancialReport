# GitHub Actions å·¥ä½œæµï¼šè‡ªåŠ¨éƒ¨ç½² MkDocs æ–‡æ¡£ç½‘ç«™
# å½“ä»£ç æ¨é€åˆ° main/master åˆ†æ”¯æ—¶ï¼Œè‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åˆ° GitHub Pages

name: Deploy MkDocs Site

# è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€å’Œæ‹‰å–è¯·æ±‚
on:
  push:
    branches:
      - main      # ä¸»åˆ†æ”¯æ¨é€æ—¶è§¦å‘
      - master    # å…¼å®¹æ—§çš„ä¸»åˆ†æ”¯åç§°
  pull_request:
    branches:
      - main      # å‘ä¸»åˆ†æ”¯æäº¤ PR æ—¶è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
      - master

# æƒé™è®¾ç½®ï¼šå…è®¸è¯»å–ä»£ç ã€å†™å…¥ Pagesã€ä½¿ç”¨ ID Token
permissions:
  contents: read    # è¯»å–ä»“åº“å†…å®¹
  pages: write      # å†™å…¥ GitHub Pages
  id-token: write   # ä½¿ç”¨ OIDC è¿›è¡Œèº«ä»½éªŒè¯

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª Pages éƒ¨ç½²ä»»åŠ¡è¿è¡Œ
concurrency:
  group: "pages"           # åŒä¸€ç»„å†…çš„ä»»åŠ¡äº’æ–¥
  cancel-in-progress: false # ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡

jobs:
  # æ„å»ºä»»åŠ¡ï¼šç”Ÿæˆé™æ€ç½‘ç«™æ–‡ä»¶
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ Git å†å²ï¼ˆç”¨äº git-revision-date æ’ä»¶ï¼‰

      # æ­¥éª¤ 2ï¼šè®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11  # ä½¿ç”¨ Python 3.11

      # æ­¥éª¤ 3ï¼šç¼“å­˜ä¾èµ–åŒ…ï¼ˆåŠ é€Ÿåç»­æ„å»ºï¼‰
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          key: ${{ github.ref }}  # åŸºäºåˆ†æ”¯/æ ‡ç­¾çš„ç¼“å­˜é”®
          path: .cache            # ç¼“å­˜è·¯å¾„

      # æ­¥éª¤ 4ï¼šå®‰è£… Python ä¾èµ–åŒ…
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip  # å‡çº§ pip
          pip install mkdocs-material          # MkDocs Material ä¸»é¢˜
          pip install mkdocs-git-revision-date-localized-plugin  # Git æ—¶é—´æˆ³æ’ä»¶
          pip install pyyaml                   # YAML å¤„ç†åº“

      # æ­¥éª¤ 5ï¼šé…ç½® GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v3

      # æ­¥éª¤ 6ï¼šç”ŸæˆåŠ¨æ€å¯¼èˆªèœå•
      # æ‰«æ archive ç›®å½•ï¼Œè‡ªåŠ¨ç”Ÿæˆ mkdocs.yml ä¸­çš„ nav é…ç½®
      - name: Generate navigation
        run: python3 scripts/generate_mkdocs_nav.py

      # æ­¥éª¤ 7ï¼šä½¿ç”¨ MkDocs æ„å»ºé™æ€ç½‘ç«™
      - name: Build with MkDocs
        run: mkdocs build  # ç”Ÿæˆé™æ€æ–‡ä»¶åˆ° site/ ç›®å½•

      # æ­¥éª¤ 8ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site  # ä¸Šä¼  site/ ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶

  # éƒ¨ç½²ä»»åŠ¡ï¼šå°†æ„å»ºäº§ç‰©éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    environment:
      name: github-pages                    # GitHub Pages ç¯å¢ƒåç§°
      url: ${{ steps.deployment.outputs.page_url }}  # éƒ¨ç½²åçš„ç½‘ç«™ URL
    runs-on: ubuntu-latest
    needs: build                           # ä¾èµ– build ä»»åŠ¡å®Œæˆ
    # åªåœ¨ä¸»åˆ†æ”¯ä¸Šéƒ¨ç½²ï¼ŒPR ä¸éƒ¨ç½²
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      # æ­¥éª¤ 1ï¼šéƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # æ­¥éª¤ 2ï¼šè¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: Display deployment info
        run: |
          # è·å–åŠ¨æ€éƒ¨ç½² URL å’Œä»“åº“ä¿¡æ¯
          DEPLOY_URL="${{ steps.deployment.outputs.page_url }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          BASE_URL="https://$REPO_OWNER.github.io/$REPO_NAME"
          
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“Š ç½‘ç«™åœ°å€ï¼š$BASE_URL/"
          echo "ğŸ”— éƒ¨ç½² URLï¼š$DEPLOY_URL"
          echo ""
          echo "ğŸ“‹ ä¸»è¦é¡µé¢é“¾æ¥ï¼š"
          echo "  ğŸ  é¦–é¡µï¼š$BASE_URL/"
          echo "  ğŸ“Š åˆ†ææŠ¥å‘Šï¼š$BASE_URL/archive/2025-09/2025-09-28/"
          echo "  ğŸ”¥ çƒ­é—¨è¯é¢˜ï¼š$BASE_URL/archive/2025-09/2025-09-28/analysis/"
          echo "  ğŸ’ æ½œåŠ›è¯é¢˜ï¼š$BASE_URL/archive/2025-09/2025-09-28/analysis/"
          echo ""
          echo "ğŸ“ éƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "  â° éƒ¨ç½²æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "  ğŸŒ¿ åˆ†æ”¯ï¼š${{ github.ref_name }}"
          echo "  ğŸ”„ è‡ªåŠ¨æ›´æ–°ï¼šæ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯éƒ½ä¼šè‡ªåŠ¨é‡æ–°éƒ¨ç½²"
          echo "  ğŸŒ ä»“åº“åœ°å€ï¼šhttps://github.com/${{ github.repository }}"
