# GitHub Actions å·¥ä½œæµï¼šæ¯æ—¥è´¢ç»æŠ¥å‘Šè‡ªåŠ¨åŒ–
# åŠŸèƒ½ï¼šæŠ“å–RSSæ–°é—» â†’ AIåˆ†æ â†’ æ„å»ºéƒ¨ç½²æ–‡æ¡£ç½‘ç«™
# è§¦å‘ï¼šæ¯å¤©ä¸¤æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 08:15ã€20:15ï¼Œæå‰15åˆ†é’Ÿåº”å¯¹å»¶è¿Ÿï¼‰+ æ‰‹åŠ¨è§¦å‘

name: Daily Financial Report

# ç»Ÿä¸€æ—¶åŒºè®¾ç½®ï¼šæ‰€æœ‰Jobä½¿ç”¨åŒ—äº¬æ—¶é—´
env:
  TZ: Asia/Shanghai

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶ä»»åŠ¡ï¼šå·²åˆ‡æ¢ä¸ºè…¾è®¯äº‘å‡½æ•°è§¦å‘ï¼Œæš‚æ—¶æ³¨é‡Šè§‚å¯Ÿå‡ å¤©
  # schedule:
  #   - cron: '15 0 * * *'  # æ¯å¤© 00:15 UTC (08:15 åŒ—äº¬æ—¶é—´) - Aè‚¡å¼€ç›˜å‰ï¼Œæå‰15åˆ†é’Ÿ
  #   - cron: '15 12 * * *'  # æ¯å¤© 12:15 UTC (20:15 åŒ—äº¬æ—¶é—´) - ç¾è‚¡å¼€ç›˜å‰ï¼Œæå‰15åˆ†é’Ÿ
  
  # æ‰‹åŠ¨è§¦å‘ï¼šç”¨äºæµ‹è¯•æˆ–è¡¥æ¼ï¼ˆè…¾è®¯äº‘å‡½æ•°é€šè¿‡æ­¤æ¥å£è§¦å‘ï¼‰
  workflow_dispatch:
    inputs:
      skip_fetch:
        description: 'è·³è¿‡æ•°æ®æŠ“å–ï¼ˆç”¨äºåªé‡æ–°åˆ†æï¼‰'
        required: false
        type: boolean
        default: false
      skip_analysis:
        description: 'è·³è¿‡AIåˆ†æï¼ˆç”¨äºåªæ›´æ–°ç½‘ç«™ï¼‰'
        required: false
        type: boolean
        default: false

# æƒé™è®¾ç½®
permissions:
  contents: write    # æäº¤æ•°æ®åº“æ›´æ–°
  pages: write       # éƒ¨ç½²åˆ° GitHub Pages
  id-token: write    # OIDC è®¤è¯

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªå·¥ä½œæµ
concurrency:
  group: daily-report
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡

jobs:
  # ========================================
  # Job 1: æ•°æ®æŠ“å–ï¼ˆRSSæ–°é—»é‡‡é›†ï¼‰
  # ========================================
  fetch-news:
    name: ğŸ“° æŠ“å–RSSæ–°é—»
    runs-on: ubuntu-latest
    # æ¡ä»¶ï¼šä¸æ˜¯æ‰‹åŠ¨è·³è¿‡æŠ“å–
    if: ${{ !inputs.skip_fetch }}
    
    outputs:
      news_count: ${{ steps.fetch.outputs.news_count }}
      has_new_data: ${{ steps.fetch.outputs.has_new_data }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´å†å²ï¼Œç”¨äºcommit
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“Š æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
        id: check_db
        run: |
          if [ -f "data/news_data.db" ]; then
            echo "âœ… æ•°æ®åº“å·²å­˜åœ¨"
            BEFORE_COUNT=$(sqlite3 data/news_data.db "SELECT COUNT(*) FROM news_articles;")
            echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æ•°æ®åº“ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°åº“"
            echo "before_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ”„ æŠ“å–RSSæ–°é—»
        id: fetch
        run: |
          echo "ğŸš€ å¼€å§‹æŠ“å–RSSæ–°é—»..."
          
          # è¿è¡ŒRSSæŠ“å–å™¨
          python3 scripts/rss_finance_analyzer.py \
            --fetch-content \
            --deduplicate \
            --max-workers 10
          
          # ç»Ÿè®¡æ–°å¢æ•°æ®
          AFTER_COUNT=$(sqlite3 data/news_data.db "SELECT COUNT(*) FROM news_articles;")
          BEFORE_COUNT=${{ steps.check_db.outputs.before_count }}
          NEW_COUNT=$((AFTER_COUNT - BEFORE_COUNT))
          
          echo "news_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          if [ $NEW_COUNT -gt 0 ]; then
            echo "has_new_data=true" >> $GITHUB_OUTPUT
            echo "âœ… æˆåŠŸæŠ“å– $NEW_COUNT æ¡æ–°é—»ï¼ˆæ€»è®¡ $AFTER_COUNT æ¡ï¼‰"
          else
            echo "has_new_data=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰æ–°æ•°æ®"
          fi
      
      - name: ğŸ’¾ æäº¤æ•°æ®åº“æ›´æ–°
        if: steps.fetch.outputs.has_new_data == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # å…ˆæäº¤æ•°æ®åº“æ›´æ”¹ï¼ˆé¿å…pullæ—¶å†²çªï¼‰
          git add data/news_data.db
          git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°æ•°æ®åº“ - æ–°å¢ ${{ steps.fetch.outputs.news_count }} æ¡æ–°é—»

          - æŠ“å–æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z') (åŒ—äº¬æ—¶é—´)
          - æ–°å¢æ•°é‡: ${{ steps.fetch.outputs.news_count }}
          - æ€»è®¡æ•°é‡: ${{ steps.fetch.outputs.total_count }}
          - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æœªæš‚å­˜çš„æ›´æ”¹ï¼ˆå¦‚æ—¥å¿—æ–‡ä»¶ï¼‰
          if ! git diff --quiet; then
            echo "âš ï¸ æ£€æµ‹åˆ°æœªæš‚å­˜çš„æ›´æ”¹ï¼ˆé€šå¸¸æ˜¯æ—¥å¿—æ–‡ä»¶ï¼‰ï¼Œæš‚å­˜å®ƒä»¬..."
            git stash push -u -m "ä¸´æ—¶ä¿å­˜æ—¥å¿—æ–‡ä»¶ç­‰"
          fi
          
          # æ¨é€å‰æ‹‰å–æœ€æ–°ä»£ç ï¼ˆä½¿ç”¨rebaseä¿æŒçº¿æ€§å†å²ï¼‰
          echo "ğŸ”„ æ¨é€å‰åŒæ­¥æœ€æ–°ä»£ç ..."
          git pull --rebase origin master || {
            echo "âš ï¸ Rebaseå†²çªï¼Œå°è¯•è§£å†³..."
            # æ•°æ®åº“æ–‡ä»¶å†²çªæ—¶ä½¿ç”¨æˆ‘ä»¬çš„ç‰ˆæœ¬ï¼ˆæ›´æ–°çš„æ•°æ®åº“ï¼‰
            git checkout --ours data/news_data.db
            git add data/news_data.db
            git rebase --continue || {
              echo "âŒ æ— æ³•è‡ªåŠ¨è§£å†³å†²çªï¼Œæ”¾å¼ƒæ¨é€"
              git rebase --abort
              exit 1
            }
          }
          
          git push
          echo "âœ… æ•°æ®åº“å·²æ›´æ–°å¹¶æ¨é€"
      
      - name: ğŸ“¤ ä¸Šä¼ æ•°æ®åº“ï¼ˆç”¨äºåç»­Jobï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: news-database
          path: data/news_data.db
          retention-days: 1

  # ========================================
  # Job 2: AIåˆ†æï¼ˆGemini + DeepSeekå¹¶è¡Œï¼‰
  # ========================================
  ai-analysis:
    name: ğŸ¤– AIåˆ†ææŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: fetch-news
    # æ¡ä»¶ï¼šæœ‰æ–°æ•°æ® ä¸” ä¸æ˜¯æ‰‹åŠ¨è·³è¿‡åˆ†æ
    if: |
      !inputs.skip_analysis && 
      (needs.fetch-news.outputs.has_new_data == 'true' || github.event_name == 'workflow_dispatch')
    
    strategy:
      matrix:
        model: [gemini, deepseek]
      fail-fast: false  # ä¸€ä¸ªæ¨¡å‹å¤±è´¥ä¸å½±å“å¦ä¸€ä¸ª
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: master  # æ€»æ˜¯ä½¿ç”¨masteræœ€æ–°ä»£ç ï¼ˆåŒ…å«æ•°æ®åº“æ›´æ–°ï¼‰
          fetch-depth: 1  # åªéœ€è¦æœ€æ–°ä»£ç ï¼Œæ— éœ€å®Œæ•´å†å²
      
      - name: ğŸ“¥ ä¸‹è½½æ•°æ®åº“
        uses: actions/download-artifact@v4
        with:
          name: news-database
          path: data/
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ¤– è¿è¡ŒAIåˆ†æ - ${{ matrix.model }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          # ä½¿ç”¨åŒ—äº¬æ—¶é—´
          TODAY=$(date '+%Y-%m-%d')
          BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
          
          echo "ğŸ“… å½“å‰åŒ—äº¬æ—¶é—´: $BEIJING_TIME"
          echo "ğŸ“… åˆ†ææ—¥æœŸ: $TODAY"
          echo "ğŸ¤– æ¨¡å‹: ${{ matrix.model }}"
          echo ""
          
          if [ "${{ matrix.model }}" = "gemini" ]; then
            echo "ğŸš€ ä½¿ç”¨ Gemini æ¨¡å‹åˆ†æ..."
            if python3 scripts/ai_analyze.py \
              --date $TODAY \
              --content-field summary \
              --max-chars 500000; then
              echo "âœ… Gemini åˆ†ææˆåŠŸ"
            else
              EXIT_CODE=$?
              echo "âŒ Gemini åˆ†æå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              exit $EXIT_CODE
            fi
          else
            echo "ğŸš€ ä½¿ç”¨ DeepSeek æ¨¡å‹åˆ†æ..."
            if python3 scripts/ai_analyze_deepseek.py \
              --date $TODAY \
              --content-field summary \
              --max-chars 500000; then
              echo "âœ… DeepSeek åˆ†ææˆåŠŸ"
            else
              EXIT_CODE=$?
              echo "âŒ DeepSeek åˆ†æå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              exit $EXIT_CODE
            fi
          fi
          
          echo ""
          echo "âœ… ${{ matrix.model }} åˆ†æå®Œæˆ"
      
      - name: ğŸ” æ£€æŸ¥ç”Ÿæˆçš„æŠ¥å‘Š
        run: |
          TODAY=$(date '+%Y-%m-%d')
          YEAR_MONTH=$(date '+%Y-%m')
          REPORT_DIR="docs/archive/$YEAR_MONTH/$TODAY/reports"
          
          echo "ğŸ“ æ£€æŸ¥æŠ¥å‘Šç›®å½•: $REPORT_DIR"
          if [ -d "$REPORT_DIR" ]; then
            echo "âœ… æŠ¥å‘Šç›®å½•å­˜åœ¨"
            FILE_COUNT=$(find "$REPORT_DIR" -name "*.md" 2>/dev/null | wc -l)
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "âœ… æ‰¾åˆ° $FILE_COUNT ä¸ªæŠ¥å‘Šæ–‡ä»¶:"
              ls -lh "$REPORT_DIR"/*.md
            else
              echo "âš ï¸ æŠ¥å‘Šç›®å½•ä¸ºç©º"
              echo "â„¹ï¸ å¯èƒ½åŸå› ï¼šä»Šæ—¥æ— æ–°æ•°æ®æˆ–åˆ†æè„šæœ¬æœªç”ŸæˆæŠ¥å‘Š"
              # ä¸é€€å‡ºï¼Œå…è®¸ç»§ç»­æ‰§è¡Œ
            fi
          else
            echo "âš ï¸ æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨"
            echo "â„¹ï¸ å¯èƒ½åŸå› ï¼šä»Šæ—¥æ— æ–°æ•°æ®ï¼ŒAI åˆ†æè„šæœ¬æœªåˆ›å»ºç›®å½•"
            echo "ğŸ’¡ è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œä¸è§†ä¸ºé”™è¯¯"
            # ä¸é€€å‡ºï¼Œå…è®¸ç»§ç»­æ‰§è¡Œ
          fi
          
          echo ""
          echo "âœ… æ£€æŸ¥å®Œæˆï¼ˆå…è®¸æ— æŠ¥å‘Šçš„æƒ…å†µï¼‰"
      
      - name: ğŸ“¤ ä¸Šä¼ æŠ¥å‘Šæ–‡ä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.model }}
          path: docs/archive/
          retention-days: 90  # ä¿ç•™90å¤©
          if-no-files-found: ignore  # æ²¡æœ‰æ–‡ä»¶æ—¶å¿½ç•¥ï¼ˆå…è®¸æ— æ•°æ®çš„æƒ…å†µï¼‰
      
      - name: ğŸ“Š æŠ¥å‘Šæ‘˜è¦
        run: |
          TODAY=$(date '+%Y-%m-%d')
          YEAR_MONTH=$(date '+%Y-%m')
          REPORT_DIR="docs/archive/$YEAR_MONTH/$TODAY/reports"
          
          echo "ğŸ“… å½“å‰æ—¥æœŸ: $TODAY"
          echo "ğŸ“… å¹´æœˆ: $YEAR_MONTH"
          echo "ğŸ“ æŠ¥å‘Šç›®å½•: $REPORT_DIR"
          echo ""
          
          if [ -d "$REPORT_DIR" ]; then
            echo "âœ… æŠ¥å‘Šç›®å½•å­˜åœ¨"
            echo ""
            echo "ğŸ“„ MarkdownæŠ¥å‘Š:"
            ls -lh $REPORT_DIR/*.md 2>/dev/null || echo "  æœªæ‰¾åˆ° .md æ–‡ä»¶"
            echo ""
            echo "ğŸ“„ å…ƒæ•°æ®æ–‡ä»¶:"
            ls -lh $REPORT_DIR/*.json 2>/dev/null || echo "  æœªæ‰¾åˆ° .json æ–‡ä»¶"
            echo ""
            echo "ğŸ“„ æ‰€æœ‰æ–‡ä»¶:"
            ls -lh $REPORT_DIR/ 2>/dev/null || echo "  ç›®å½•ä¸ºç©º"
            echo ""
            echo "ğŸ“¦ å½“å‰æ¨¡å‹æŠ¥å‘Š:"
            ls -lh $REPORT_DIR/*${{ matrix.model }}* 2>/dev/null || echo "  æœªæ‰¾åˆ° ${{ matrix.model }} ç›¸å…³æ–‡ä»¶"
          else
            echo "âŒ æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨: $REPORT_DIR"
            echo "ğŸ“ æŸ¥çœ‹çˆ¶ç›®å½•ç»“æ„:"
            ls -lh "docs/archive/$YEAR_MONTH/" 2>/dev/null || echo "  æœˆä»½ç›®å½•ä¸å­˜åœ¨"
          fi

  # ========================================
  # Job 3: åˆå¹¶æŠ¥å‘Šå¹¶æäº¤
  # ========================================
  commit-reports:
    name: ğŸ’¾ æäº¤åˆ†ææŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: ${{ !cancelled() }}  # å³ä½¿AIåˆ†æéƒ¨åˆ†å¤±è´¥ä¹Ÿæ‰§è¡Œ
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: master  # æ€»æ˜¯ä½¿ç”¨masteræœ€æ–°ä»£ç 
          fetch-depth: 0
      
      - name: ğŸ“¥ ä¸‹è½½GeminiæŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: reports-gemini
          path: /tmp/reports-gemini/
        continue-on-error: true
      
      - name: ğŸ“¥ ä¸‹è½½DeepSeekæŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: reports-deepseek
          path: /tmp/reports-deepseek/
        continue-on-error: true
      
      - name: ğŸ”€ åˆå¹¶ä¸¤ä¸ªæ¨¡å‹çš„æŠ¥å‘Š
        run: |
          echo "ğŸ“¦ åˆå¹¶ Gemini å’Œ DeepSeek æŠ¥å‘Šåˆ° docs/archive/"
          echo ""
          
          # è°ƒè¯•ï¼šæŸ¥çœ‹å®é™…çš„ç›®å½•ç»“æ„
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - Gemini artifact ç›®å½•ç»“æ„ï¼š"
          ls -la /tmp/reports-gemini/ 2>/dev/null || echo "  Gemini ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨"
          echo ""
          
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - DeepSeek artifact ç›®å½•ç»“æ„ï¼š"
          ls -la /tmp/reports-deepseek/ 2>/dev/null || echo "  DeepSeek ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # å¤åˆ¶ Gemini æŠ¥å‘Š
          # Artifactä¸‹è½½åï¼Œå†…å®¹ç›´æ¥åœ¨ä¸´æ—¶ç›®å½•ä¸‹ï¼ˆä¸åŒ…å«docs/archiveè·¯å¾„ï¼‰
          if [ -d "/tmp/reports-gemini" ] && [ "$(ls -A /tmp/reports-gemini 2>/dev/null)" ]; then
            echo "âœ… å¤åˆ¶ Gemini æŠ¥å‘Š..."
            # å¦‚æœæœ‰docs/archiveå­ç›®å½•ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ç›´æ¥å¤åˆ¶å†…å®¹
            if [ -d "/tmp/reports-gemini/docs/archive" ]; then
              cp -r /tmp/reports-gemini/docs/archive/* docs/archive/ 2>/dev/null || true
            else
              cp -r /tmp/reports-gemini/* docs/archive/ 2>/dev/null || true
            fi
            GEMINI_COUNT=$(find /tmp/reports-gemini -type f \( -name "*.md" -o -name "*.json" \) | wc -l)
            echo "  ğŸ“„ Gemini æ–‡ä»¶æ•°: $GEMINI_COUNT"
            find /tmp/reports-gemini -type f \( -name "*.md" -o -name "*.json" \) | head -10 | while read file; do
              echo "    ğŸ“„ $(basename "$file")"
            done
          else
            echo "âš ï¸ Gemini æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          fi
          
          echo ""
          
          # å¤åˆ¶ DeepSeek æŠ¥å‘Š
          if [ -d "/tmp/reports-deepseek" ] && [ "$(ls -A /tmp/reports-deepseek 2>/dev/null)" ]; then
            echo "âœ… å¤åˆ¶ DeepSeek æŠ¥å‘Š..."
            # å¦‚æœæœ‰docs/archiveå­ç›®å½•ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ç›´æ¥å¤åˆ¶å†…å®¹
            if [ -d "/tmp/reports-deepseek/docs/archive" ]; then
              cp -r /tmp/reports-deepseek/docs/archive/* docs/archive/ 2>/dev/null || true
            else
              cp -r /tmp/reports-deepseek/* docs/archive/ 2>/dev/null || true
            fi
            DEEPSEEK_COUNT=$(find /tmp/reports-deepseek -type f \( -name "*.md" -o -name "*.json" \) | wc -l)
            echo "  ğŸ“„ DeepSeek æ–‡ä»¶æ•°: $DEEPSEEK_COUNT"
            find /tmp/reports-deepseek -type f \( -name "*.md" -o -name "*.json" \) | head -10 | while read file; do
              echo "    ğŸ“„ $(basename "$file")"
            done
          else
            echo "âš ï¸ DeepSeek æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ åˆå¹¶åçš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          TODAY=$(date '+%Y-%m-%d')
          YEAR_MONTH=$(date '+%Y-%m')
          if [ -d "docs/archive/$YEAR_MONTH/$TODAY/reports" ]; then
            echo "âœ… ä»Šæ—¥æŠ¥å‘Šç›®å½•: docs/archive/$YEAR_MONTH/$TODAY/reports"
            ls -lh "docs/archive/$YEAR_MONTH/$TODAY/reports/" 2>/dev/null || echo "  ç›®å½•ä¸ºç©º"
          else
            echo "âš ï¸ ä»Šæ—¥æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨"
          fi
          
          if [ -d "docs/archive/$YEAR_MONTH/$TODAY/metadata" ]; then
            echo "âœ… ä»Šæ—¥å…ƒæ•°æ®ç›®å½•: docs/archive/$YEAR_MONTH/$TODAY/metadata"
            ls -lh "docs/archive/$YEAR_MONTH/$TODAY/metadata/" 2>/dev/null || echo "  ç›®å½•ä¸ºç©º"
          fi
      
      - name: ğŸ’¾ æäº¤æŠ¥å‘Šåˆ°ä»“åº“
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "ğŸ“Š Git çŠ¶æ€æ£€æŸ¥ï¼š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          git status --short docs/archive/ || echo "æ— å˜æ›´"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
          git add docs/archive/
          
          echo "ğŸ“¦ å‡†å¤‡æäº¤çš„æ–‡ä»¶ï¼š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          git diff --cached --name-status || echo "æ— æ–‡ä»¶éœ€è¦æäº¤"
          echo ""
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ–°æŠ¥å‘Šéœ€è¦æäº¤"
          else
            TODAY=$(date '+%Y-%m-%d')
            BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
            
            echo "âœ… å‘ç°æ–°æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤..."
            echo "ğŸ“… æ—¥æœŸ: $TODAY"
            echo "ğŸ• æ—¶é—´: $BEIJING_TIME"
            
            git commit -m "ğŸ¤– è‡ªåŠ¨ç”Ÿæˆè´¢ç»åˆ†ææŠ¥å‘Š - $TODAY

            - ç”Ÿæˆæ—¶é—´: $BEIJING_TIME (åŒ—äº¬æ—¶é—´)
            - åŒ…å«æ¨¡å‹: Gemini, DeepSeek
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æœªæš‚å­˜çš„æ›´æ”¹ï¼ˆå¦‚æ—¥å¿—æ–‡ä»¶ï¼‰
            if ! git diff --quiet; then
              echo "âš ï¸ æ£€æµ‹åˆ°æœªæš‚å­˜çš„æ›´æ”¹ï¼Œæš‚å­˜å®ƒä»¬..."
              git stash push -u -m "ä¸´æ—¶ä¿å­˜æ—¥å¿—æ–‡ä»¶ç­‰"
            fi
            
            # æ¨é€å‰å†æ¬¡æ‹‰å–ï¼ˆé¿å…æ¨é€æ—¶å†²çªï¼‰
            git pull --rebase origin master || {
              echo "âš ï¸ Rebaseå†²çªï¼Œå°è¯•è§£å†³..."
              git add docs/archive/
              git rebase --continue || {
                echo "âŒ æ— æ³•è‡ªåŠ¨è§£å†³å†²çªï¼Œæ”¾å¼ƒæ¨é€"
                git rebase --abort
                exit 1
              }
            }
            
            git push
            echo "âœ… æŠ¥å‘Šå·²æäº¤å¹¶æ¨é€"
          fi

  # ========================================
  # Job 4: æ„å»ºå¹¶éƒ¨ç½²MkDocsç½‘ç«™
  # ========================================
  build-and-deploy:
    name: ğŸš€ æ„å»ºéƒ¨ç½²æ–‡æ¡£ç½‘ç«™
    runs-on: ubuntu-latest
    needs: commit-reports
    if: ${{ !cancelled() }}  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿå°è¯•éƒ¨ç½²
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: master  # æ€»æ˜¯ä½¿ç”¨masteræœ€æ–°ä»£ç ï¼ˆåŒ…å«æŠ¥å‘Šï¼‰
          fetch-depth: 1  # åªéœ€è¦æœ€æ–°ä»£ç 
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“ ç”Ÿæˆå¯¼èˆªé…ç½®
        run: |
          python3 scripts/generate_mkdocs_nav.py
          echo "âœ… å¯¼èˆªé…ç½®ç”Ÿæˆå®Œæˆ"
      
      - name: ğŸ”¨ æ„å»ºMkDocsç½‘ç«™
        run: |
          mkdocs build
          echo "âœ… MkDocsæ„å»ºå®Œæˆ"
      
      - name: ğŸ” å¤åˆ¶å®‰å…¨éªŒè¯æ–‡ä»¶
        run: |
          if [ -f "946d30b6403dda237744cead6645a0ae.txt" ]; then
            cp 946d30b6403dda237744cead6645a0ae.txt site/
            echo "âœ… å®‰å…¨éªŒè¯æ–‡ä»¶å·²å¤åˆ¶"
          fi
      
      - name: ğŸ“¤ ä¸Šä¼ Pagesæ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site
      
      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: âœ… éƒ¨ç½²å®Œæˆ
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ”— ç½‘ç«™åœ°å€: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z') (åŒ—äº¬æ—¶é—´)"

  # ========================================
  # Job 5: å‘é€é€šçŸ¥
  # ========================================
  notify:
    name: ğŸ“¬ å‘é€å®Œæˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [fetch-news, ai-analysis, build-and-deploy]
    if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
    
    steps:
      - name: ğŸ“Š æ±‡æ€»å·¥ä½œæµçŠ¶æ€
        id: summary
        run: |
          # è·å–åŒ—äº¬æ—¶é—´
          BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
          
          # ç”ŸæˆGitHubæ‘˜è¦
          echo "## ğŸ¯ æ¯æ—¥è´¢ç»æŠ¥å‘Š - å·¥ä½œæµå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $BEIJING_TIME (åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- æ•°æ®æŠ“å–: ${{ needs.fetch-news.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- AIåˆ†æ: ${{ needs.ai-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç½‘ç«™éƒ¨ç½²: ${{ needs.build-and-deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.fetch-news.outputs.news_count }}" != "" ]; then
            echo "### ğŸ“° æ•°æ®ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- æ–°å¢æ–°é—»: ${{ needs.fetch-news.outputs.news_count }} æ¡" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å‡†å¤‡é‚®ä»¶å†…å®¹å˜é‡
          FETCH_STATUS="${{ needs.fetch-news.result }}"
          ANALYSIS_STATUS="${{ needs.ai-analysis.result }}"
          DEPLOY_STATUS="${{ needs.build-and-deploy.result }}"
          NEWS_COUNT="${{ needs.fetch-news.outputs.news_count }}"
          
          # åˆ¤æ–­æ•´ä½“çŠ¶æ€
          if [ "$FETCH_STATUS" = "success" ] && [ "$ANALYSIS_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
            OVERALL_STATUS="âœ… æˆåŠŸ"
            EMOJI="âœ…"
          else
            OVERALL_STATUS="âŒ éƒ¨åˆ†å¤±è´¥"
            EMOJI="âš ï¸"
          fi
          
          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "fetch_status=$FETCH_STATUS" >> $GITHUB_OUTPUT
          echo "analysis_status=$ANALYSIS_STATUS" >> $GITHUB_OUTPUT
          echo "deploy_status=$DEPLOY_STATUS" >> $GITHUB_OUTPUT
          echo "news_count=${NEWS_COUNT:-0}" >> $GITHUB_OUTPUT
      
      - name: ğŸ“¥ æ£€å‡ºä»£ç ï¼ˆç”¨äºè¿è¡ŒPythonè„šæœ¬ï¼‰
        if: vars.EMAIL_NOTIFICATION_ENABLED == 'true'
        uses: actions/checkout@v4
        with:
          ref: master  # ä½¿ç”¨æœ€æ–°ä»£ç 
          fetch-depth: 1
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        if: vars.EMAIL_NOTIFICATION_ENABLED == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ å®‰è£…é‚®ä»¶é€šçŸ¥ä¾èµ–
        if: vars.EMAIL_NOTIFICATION_ENABLED == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML pytz
      
      - name: ğŸ“§ å‘é€é€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰
        if: vars.EMAIL_NOTIFICATION_ENABLED == 'true'
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          # ä½¿ç”¨ä¸»é¡µåœ°å€ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          REPORT_URL="https://qipeijun.github.io/FinancialReport/"
          
          echo "ğŸ“… å½“å‰åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”— æŠ¥å‘Šç½‘ç«™: ${REPORT_URL}"
          
          python3 scripts/send_notification.py \
            --fetch-status ${{ steps.summary.outputs.fetch_status }} \
            --analysis-status ${{ steps.summary.outputs.analysis_status }} \
            --deploy-status ${{ steps.summary.outputs.deploy_status }} \
            --news-count ${{ steps.summary.outputs.news_count }} \
            --trigger ${{ github.event_name }} \
            --website-url "${REPORT_URL}" \
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --repository "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --channels email
        continue-on-error: true

